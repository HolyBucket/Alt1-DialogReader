<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Alt1 Dialog Reader</title>
  <script src="https://cdn.jsdelivr.net/npm/@alt1/base@1.0.0-alpha.7/dist/index.bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@alt1/dialog@1.0.0-alpha.7/dist/index.bundle.js"></script>
  <style>
    body { margin:0; font-family: sans-serif; background: rgba(0,0,0,0); }
    #status {
      position: absolute;
      top: 10px; left: 10px;
      padding: 5px 10px;
      background: rgba(0,0,0,0.7);
      color: #fff; border-radius: 4px;
      font-size: 14px;
    }
    #debug {
      position: absolute;
      bottom: 10px; left: 10px;
      padding: 5px; background: rgba(0,0,0,0.7);
      color: #0f0; font-size: 12px; max-width: 300px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div id="status">Initializing…</div>
  <div id="debug"></div>
  <script>
    const statusEl = document.getElementById("status");
    const debugEl = document.getElementById("debug");
    const reader = new alt1.DialogReader();
    let lastText = "";
    let speaking = false;

    function setStatus(s) {
      statusEl.textContent = s;
    }

    function logDebug(...args) {
      const now = new Date().toLocaleTimeString();
      debugEl.textContent = now + " — " + args.map(a => JSON.stringify(a)).join(" | ") + "\n" + debugEl.textContent;
    }

    setStatus("Searching for dialog");

    setInterval(async () => {
      try {
        // Try to read via Alt1 DialogReader
        const result = reader.read();
        logDebug("DialogReader result", result);
        if (result && result.text && Array.isArray(result.text)) {
          const fullText = result.text.join(" ").trim();
          logDebug("OCR‑text", fullText);
          if (fullText && fullText !== lastText) {
            lastText = fullText;
            setStatus("Reading");
            logDebug("New text → speaking", fullText);
            const utter = new SpeechSynthesisUtterance(fullText);
            utter.rate = 1.0;
            utter.onend = () => {
              speaking = false;
              setStatus("Waiting for new dialog");
              logDebug("Speech ended");
            };
            speaking = true;
            window.speechSynthesis.speak(utter);
          }
        } else {
          // No dialog detected
          if (!speaking) {
            setStatus("Searching for dialog box");
          }
        }
      } catch (err) {
        logDebug("Error in loop", err.toString());
        console.error(err);
      }
    }, 500);
  </script>
</body>
</html>
