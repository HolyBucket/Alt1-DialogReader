<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Alt1 Dialog Reader</title>
  <style>
    body {
      margin: 0;
      padding: 10px;
      font-family: Arial, sans-serif;
      background-color: rgba(0,0,0,0.8);
      color: #fff;
    }
    #state {
      font-size: 18px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="state">Initializing...</div>
  <script>
    (async () => {
      const stateEl = document.getElementById("state");
      let lastSpoken = "";

      function setState(text) {
        stateEl.textContent = text;
      }

      function speakText(text) {
        return new Promise(resolve => {
          const utter = new SpeechSynthesisUtterance(text);
          utter.rate = 1.0;
          utter.onend = resolve;
          window.speechSynthesis.speak(utter);
        });
      }

      setState("Searching for dialog box");

      // Alt1 element ID for NPC dialog in RS3: "npc_dialog"
      const npcDialogElement = await alt1.findUiElement("npc_dialog");

      if (!npcDialogElement) {
        setState("Dialog box not found. Make sure RS3 is running.");
        return;
      }

      // Watch for changes in the dialog box
      setInterval(async () => {
        try {
          const rect = await npcDialogElement.rect(); // get dialog box rectangle
          const img = await alt1.captureRect(rect.x, rect.y, rect.width, rect.height);

          // OCR only inside dialog box
          let lines = await alt1.ocr.parse(img);
          if (!Array.isArray(lines)) lines = [lines];

          // Combine all lines
          let dialog = lines.filter(l => l.trim()).join(" ").trim();

          // Only read new dialog
          if (dialog && dialog !== lastSpoken) {
            lastSpoken = dialog;
            setState("Reading");
            await speakText(dialog);
            setState("Waiting for more");
          } else {
            setState("Searching for dialog box");
          }

        } catch (err) {
          console.error(err);
        }
      }, 500); // check twice per second for faster detection
    })();
  </script>
</body>
</html>
